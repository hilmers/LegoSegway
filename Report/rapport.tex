%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Detta är ett exempel på ett latexdokument.
% 
% Alla dokument består av följande delar:
%
%          \documentclass[optioner]{dokumentklass}
%            ...inställningar...
%          \begin{document}
%            ...text...
%          \end{document}
%
% Som ni kanske redan har förstått är används procent (%) för
% kommentarer.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\documentclass[a4paper]{article}

\usepackage[T1]{fontenc}                % För svenska bokstäver
\usepackage[swedish]{babel}             % För svensk avstavning och svenska
                                        % rubriker (t ex "innehållsförteckning)
\title{FRTN01 Project \\
Group 1: Lego Segway}
\author{
		Kristoffer Hilmersson, dat11khi@student.lu.se\\
		Alexander Karlsson, dat11aka@student.lu.se\\
		Erik Stenlund, zba10est@student.lu.se\\
		Axel Ahlbeck, dat11aah@student.lu.se}
       % Blir dagens datum om det utelämnas

\begin{document}

\maketitle        
\newpage              % Skriver ut rubriken som vi
\tableofcontents
                                % deklarerade ovan med \title, \author
\newpage                                % och eventuellt \date

\section{Introduction}          % Detta kommando gör en rubrik

							       % Detta blir en underru
 This report is about our attempt to control a Segway build using Lego EV3 . Our objections for this project where to make the Segway to be able to self-balance, reject external disturbances and to be able to receive external commands for setpoint generation. This was done by first making a simple model of the problem that was used to design the controller. The the controller was then implemented in software that ran on the Segway. The project consisted of a couple of different steps. At first we had to build the actual Lego Segway, then we had to analyse the model to determine which type of controller to use. After desideing which type of controller to use we started with a simpler model and had to fine tune the parameter to make the Segway stabilize. The fine tuning was done by experiments. ... ... ... ... ... . .. ... ... 




 \section{The Lego Segway}
 The Segway were built using the Lego Mindstorms EV3 set. We desided to use a Hightonic Gyrosensor which measures the current angular velocity as our only sensor, using that signal we were able to calculate the current angle of the Segway. On the EV3 brick we ran the firmware leJOS instead of the regular Mindstorms firmware. LejOS includes a JVM (Java Virtual Machine) which makes it possible to program the segway in java. EV3 Large Servo motors were used for controlling the wheels. By measuring the number of degrees the motor axis had rotated the position relative to the startpoint could be estimated. The relative position could the be derivied to form an estimate of the speed. 

\section{Segway Model}
A segway is a inverted pendulum on a cart. To be able to keep the pendulum, in this case the segway, upright the cart has to move backward or forward to reject the forces of gravity. To be able achive this a controller of the carts wheels is introduced to minimize the tilt of pendulum on the cart. This implies that the pendulum falling forwards causes the cart to move forward. Simirially the cart has to move backward to reject the pendulum from falling backwards. 


\section{Control Design}
The desing of the controller used in this project will be divided into the part. 
At first our goal is to be able to make the Segway balance using a single PID-regulator. This controller will be implemented to keep the angle of the segway relative to the normal of the ground to zero. During this part we will use different methods both analytic and empirical to define appropiate parameter values for the regulator.

 When this is achived and the Segway is able to balance our plan is to extend the controller and instead of one PID-regualtor use two cascaded coupled PID-regulators. The input to the outer PID will be the desired position of the Segway that signal will be used as input to the inner regulator which calculates the control signal to the motors. This would make it possible for us to both balance the Segway and to move it forward and backward. Setpoints will then be introduced to limit the signal to either of the wheels, this will make it possible to also steer the Segway to right or left.



%FRÅN INFÖR
The system will be controlled using a single PID-controller. Since the only measurable output is the angle offset to the horizontal plane, the system can be controlled with a single controller, this angle will serve as our reference. The controller will need to be very precise when controlling the system, which suggests that all three parts of the controller will have to be used. Additionally, the parameters of the different parts will have to be fine-tuned in order to achieve stability.
    Assuming that the sensor will output an analog signal, the controller has to be able to sample the signal to compute its control signal. Given the fact that a segway is very sensitive to errors, the controller will need to sample rather fast in order to keep the segway balanced at all times.

To further stabilize the segway, state feedback will be used. This is to prevent the segway from falling due to slanting floors or dirt in its way. The segway should be able to balance regardless of where it is placed (within reasonable limits, of course).


\section{Program}
Our program consists of two different parts. One Segway program that runs on the LEGO Mindstorm unit that handles the control of the Segway. The other program is the Operator program that runs on a computer and is used for setting the reference- and parameter values to the Segway. It is also used to plot the signals from the LEGO gyroscope, the calculated control signal and the reference value in a window. 
%FRÅN INFÖR

%The program consists of two different parts. One Segway program that runs on the LEGO Mindstorm unit that handles the control of the Segway. The other program is the Operator program that runs on a computer and is used for setting the reference- and parameter values to the Segway. It is also used to plot the signals from the LEGO gyroscope, the calculated control signal and the reference value in a window. %Vilka signaler det nu är

\subsection{Segway}
The program runned on the Segway is stored in the package called hardware (see figure 1 for UML-diagram). It consists of a Main program that starts the controller thread (the Regul class) and the thread used for communication between the LEGO program and the Operator program called CommunicationThread. All shared data that between the threads are stored in a class called Monitor, this class contains synchronized get- and set-methods which enables the threads to share their data in a thread safe way. The controller is implemented in a class called Regul. Regul contains an instance of the class Segway which in its turn contains instances of the classes SegwayMotor and GyroSensor these classes contains methods to controll the motors and read gyroscope values. Using the values from the gyrosensor regulator calculates the control values that is sent to the motors by using instances of the class PID which is an implementation of a PID-regulator. The controller both limits the signals and uses anti-windup for the I-part of the controller. 


\subsection{Operator}
The Operator program (see figure 2 for UML-diagram)  contains a Main class that starts two threads. One, the CommunicationThread, reads the values of the signals from the Segway program and updates a monitor that contains the current values. PlotThread is used to read current signal values from the monitor and update the PlotOperatorGUI. There is two controller input GUI:s, ParameterGUI and ReferenceGUI that read the preferred reference value and parameters from the graphical interface and by using an actionhandler stores the new reference value in the monitor. The communication thread then reads the reference signal from the monitor and sends, if necessary, the new reference value to the Segway.

  %Detta blir en underunderrubrik

\end{document}                 % The input file ends with this command.
